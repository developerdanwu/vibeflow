# VibeFlow - AI Agent Instructions

## Project Overview

VibeFlow is a personal productivity calendar application built with React 19, TanStack Start (SSR), and Convex for real-time data synchronization. The app integrates with Google Calendar via OAuth, enables time blocking for focused work, and provides productivity analytics. Authentication is handled by WorkOS AuthKit.

**Key Technologies:** React 19 • TypeScript • Vite • TanStack Router • Convex • WorkOS • XState Store • Tailwind CSS v4 • Motion

**Documentation:** 
- See [SPEC.md](./SPEC.md) for product requirements and features
- See [UI_SPEC.md](./UI_SPEC.md) for comprehensive UI/UX design, routes, and components

---

## How to Run, Build, and Test

### Prerequisites
```bash
# Required environment variables in .env.local:
VITE_WORKOS_CLIENT_ID=your_workos_client_id
VITE_WORKOS_API_HOSTNAME=api.workos.com
VITE_CONVEX_URL=your_convex_url
CONVEX_DEPLOYMENT=your_convex_deployment
```

### Essential Commands
```bash
# Install dependencies (use pnpm only)
pnpm install

# Start development server (runs on port 3000)
pnpm dev

# Start Convex backend (run in separate terminal)
pnpm convex:dev

# Production build
pnpm build

# Preview production build
pnpm preview

# Run tests
pnpm test

# Type checking and linting
pnpm check         # Run typecheck + lint + format (recommended before commits)
pnpm typecheck     # Check TypeScript types only
pnpm lint          # Run Biome linter only
pnpm format        # Format code with Biome only

# Build for deployment (output in dist/)
pnpm deploy        # Same as pnpm build; deploy dist/ to your host (e.g. Vercel, Netlify)
```

### Common Pitfalls
- **Convex Backend:** Must run `pnpm convex:dev` in a separate terminal before starting the app
- **Environment Variables:** All VITE_ prefixed variables must be set for the app to function
- **Port Conflicts:** Dev server runs on port 3000 by default
- **Node Version:** Requires Node.js 18+

---

## Code Structure and Important Paths

```
vibeflow/
├── src/                      # Main application code
│   ├── routes/              # TanStack Router file-based routes
│   │   ├── __root.tsx       # Root layout component
│   │   ├── index.tsx        # Home page
│   │   └── *.tsx            # Other route components
│   ├── components/          # React components
│   │   └── ui/             # shadcn/ui components
│   ├── lib/                # Utility functions and helpers
│   ├── integrations/       # External service integrations
│   ├── hooks/              # Custom React hooks
│   ├── data/               # Static data and constants
│   └── styles.css          # Global styles (DO NOT EDIT - generated)
│
├── convex/                  # Convex backend
│   ├── _generated/         # DO NOT EDIT - auto-generated types
│   ├── schema.ts           # Database schema definitions
│   └── *.ts                # Convex functions (queries, mutations, actions)
│
├── public/                  # Static assets
│
├── .content-collections/    # DO NOT EDIT - generated cache
├── .tanstack/              # DO NOT EDIT - generated query cache
├── routeTree.gen.ts        # DO NOT EDIT - generated by TanStack Router
│
└── Configuration Files
    ├── vite.config.ts      # Vite configuration
    ├── tsconfig.json       # TypeScript configuration
    ├── biome.json          # Biome linter/formatter config
    ├── components.json     # shadcn/ui configuration
```

### Where to Add New Code
- **New Pages:** Create `.tsx` files in `src/routes/`
- **Shared Components:** Add to `src/components/`
- **Database Logic:** Create functions in `convex/`
- **UI Components:** Use `pnpm dlx shadcn@latest add [component]`
  - **Overwrite prompts:** If shadcn prompts to overwrite existing files, ask the user whether to overwrite or not. Do not use `--overwrite` flag automatically. The `--yes` flag only skips initial confirmation, not overwrite prompts.

### Agent Skills
- **Master copy:** Skills live in `.agents/skills/`. This is the single source of truth.
- **Copies:** Copies live in `.cursor/skills/` and `.opencode/skills/` because Cursor and OpenCode do not reliably discover symlinked skills.
- **Editing skills:** Edit the master copy in `.agents/skills/` only. Then sync to copies using `cp` (do not manually re-write the same content into each copy). Example for a skill named `planning`: `cp -r .agents/skills/planning/. .cursor/skills/planning/` and `cp -r .agents/skills/planning/. .opencode/skills/planning/`.

---

## Coding Style and Conventions

### Language and Framework Rules
- **TypeScript Only:** No plain JavaScript files in `src/`
- **React 19:** Use modern patterns (Server Components when applicable)
- **File-based Routing:** Routes are auto-generated from `src/routes/`
- **Component Style:** Functional components with hooks only

### Naming Conventions
- **Files:** 
  - Routes: `kebab-case.tsx` (e.g., `calendar-view.tsx`)
  - Components: `PascalCase.tsx` (e.g., `TimeBlockCard.tsx`)
  - Utilities: `camelCase.ts` (e.g., `formatDate.ts`)
  - Convex functions: `camelCase.ts` (e.g., `getTasks.ts`)
- **Variables/Functions:** camelCase
- **Types/Interfaces:** PascalCase with `T` or `I` prefix when needed
- **Constants:** UPPER_SNAKE_CASE for true constants
- **Database Fields:** camelCase for all Convex schema fields (e.g., `startDateStr`, `timeZone`, NOT `start_date`, `time_zone`)

### Code Formatting
- **Indentation:** Tabs (enforced by Biome)
- **Quotes:** Double quotes for strings
- **Semicolons:** Required
- **Import Order:** Auto-organized by Biome on save
- **Variable declarations:** Prefer `const` over `let`; use `let` only when reassignment is required. Refactor conditionally assigned values (e.g. `let x; if (a) x = ...; else x = ...`) into a single `const` (e.g. ternary, IIFE returning a value, or a small helper that returns the value).
- **Control flow:** Prefer early returns / short-circuit with `return` to keep conditional logic linear; avoid nested if/else where a linear flow is clearer. Applies to any conditional logic (validation, handlers, utilities). See [src/docs/ui.md](src/docs/ui.md) for a form-validation example.
- **Guards with return:** Prefer braces for return statements, even when the body is only `return`. Write `if (condition) { return; }` rather than `if (condition) return;`.
- **Building objects:** Prefer object spreading over mutating a single object. Build payloads and config objects with one object literal and conditional spreads (e.g. `{ id, ...(x ? { key: x } : {}) }`) instead of declaring a base object and assigning properties in multiple `if` blocks. When you need to type the object, use **`satisfies SomeType`** rather than `: SomeType` or `as SomeType`. See [convex/docs/patterns.md](convex/docs/patterns.md) (Building object literals and typing).

### Biome Linter Configuration

**Disabled accessibility rules:** The following a11y rules are disabled in `biome.json` to allow interactive static elements (e.g., divs with onClick handlers):
- `useKeyWithClickEvents` - Allows onClick without keyboard handlers
- `useSemanticElements` - Allows divs/span with interactive roles
- `noStaticElementInteractions` - Allows static elements (div, span) with click handlers

**Why:** Some UI patterns (e.g., TipTap editor wrapper, custom interactive components) require interactive static elements. These rules are disabled globally to avoid false positives.

### Date and time
- **Prefer date-fns for date/time manipulation** - Use date-fns utilities (e.g. `set`, `setHours`, `startOfDay`, `addDays`, `differenceInMinutes`) for consistency and immutability. Avoid mutating native `Date` with `setHours`/`setMinutes`; use date-fns equivalents that return new dates instead.
- **Use date-fns built-ins instead of reimplementing** - For common checks use the library’s helpers (e.g. `isToday(date)`, `isSameDay(a, b)`) rather than writing your own (e.g. `isSameDay(d, new Date())` for “is today”). See [date-fns](https://date-fns.org/docs/Home) for the full API.

### Imports
- **Use import aliases where possible** - Prefer `@/` over relative paths
- `@/*` maps to `src/*` directory

```tsx
// ✅ Correct - Use import aliases
import { Button } from "@/components/ui/button";
import { useUser } from "@/hooks/useUser";
import { formatDate } from "@/lib/utils";

// ❌ Wrong - Avoid relative paths when alias is available
import { Button } from "../../../components/ui/button";
import { useUser } from "../../hooks/useUser";
```

### Convex Patterns
- Follow schema patterns in [convex/docs/schema.md](convex/docs/schema.md) and [convex/AGENTS.md](convex/AGENTS.md)
- Use `v` validators for all schema fields
- Include proper indexes for query performance
- System fields (`_id`, `_creationTime`) are automatic

### Git Conventions
- **Branch Names:** `feature/description` or `fix/description`
- **Commit Messages:** Conventional commits (e.g., `feat:`, `fix:`, `docs:`)
- **PR Size:** Keep changes focused and under 500 lines when possible

---

## Testing and Verification Rules

### Required Before Marking Complete
1. **Full Check:** Run `pnpm check` - MUST pass (includes typecheck, lint, format)
2. **Unit Tests:** Run `pnpm test` - all tests must pass
3. **Build Verification:** `pnpm build` must complete successfully
4. **Convex Functions:** Test mutations/queries in Convex dashboard

**IMPORTANT:** Always run `pnpm check` after:
- Adding/modifying components
- Changing type definitions
- Updating dependencies
- Refactoring existing code
- Changing Convex functions or test setup (and run `pnpm test` so Convex tests pass)

### Test Coverage Requirements
- **New Features:** Must include tests for critical paths
- **Bug Fixes:** Must include regression test
- **UI Components:** Visual testing not required, but interaction tests recommended
- **Convex Functions:** Test data validation and error cases

### When to Run Tests
- **Small Changes:** Run `pnpm check` and relevant unit tests
- **Large Changes:** Full test suite (`pnpm test`) + build verification
- **Before PR:** All checks must pass

### UI and Browser Testing
- **Cursor Browser:** Use the Cursor browser for UI-related work and testing. Validate and correct the UI by running the app and verifying layout, interactions, and behavior in the browser.
- **Auth for testing:** When testing flows that require login, use **developerdanwu@gmail.com** as the Google login account.

---

## Security, Safety, and Constraints

### NEVER Touch Without Explicit Permission
- **Environment Variables:** Never commit `.env.local` or expose secrets
- **Generated Files:** 
  - `convex/_generated/*`
  - `routeTree.gen.ts`
  - `.content-collections/*`
  - `.tanstack/*`
  - `src/styles.css`
- **Authentication:** Do not modify WorkOS configuration without guidance
- **Database Migrations:** Never manually edit Convex schema in production

### API and External Services
- **Google Calendar API:** Always use OAuth, never store raw credentials
- **WorkOS:** Only use provided SDK methods, don't bypass auth
- **Convex:** Use proper validators, never bypass type safety

### Data Privacy Rules
- **PII:** Never log personal information (emails, names, calendar data)
- **Calendar Data:** Treat all calendar information as sensitive
- **Analytics:** Aggregate only, no individual user tracking
- **Error Reporting:** Sanitize stack traces before sending

### Rate Limiting Awareness
- Google Calendar API has quotas - implement exponential backoff
- Convex functions have execution limits - batch operations when possible
- WorkOS has rate limits - cache auth tokens appropriately

---

## Agent-Specific Instructions

### Task Approach Philosophy
1. **Read First:** Always read existing code before writing new code
2. **Small Changes:** Prefer incremental updates over rewrites
3. **Use Existing Patterns:** Follow conventions already in the codebase
4. **Explain Significant Changes:** Document why, not just what
5. **Test Locally:** Verify changes work before marking complete
6. **Learn and Document:** Use coding sessions as learning opportunities; when mistakes or corrections are made during coding, update relevant docs (e.g. AGENTS.md, src/docs/*.md) so future sessions benefit

### When Working on Features
1. **Check SPEC.md** for requirements and acceptance criteria
2. **Check UI_SPEC.md** for visual design, routes, and component specifications
3. **Review existing similar features** for patterns to follow
4. **For multi-step or multi-file plans,** structure tasks with agent and sub-agent assignment in mind (owners, dependencies, handoffs). See [docs/planning.md](docs/planning.md).
5. **Start with Convex schema** if database changes needed
6. **Build UI components** using existing component library
7. **Add proper TypeScript types** for all new code
8. **Write tests** for critical functionality

### Before Creating New Files
- **Routes:** Check if route already exists or can be nested
- **Components:** Look for existing similar components to extend
- **Utilities:** Search for existing helpers before writing new ones
- **Convex Functions:** Group related functions in same file

### Integration Guidelines
- **Google Calendar:** Use existing OAuth flow in WorkOS
- **Animations:** Use the **Motion** package (not framer-motion). Import from `"motion/react"` (e.g. `import { motion } from "motion/react"`) and use `motion.div`, `motion.button`, etc. for animated elements. Use `initial={false}` when you want no enter animation. For smooth numeric transitions (e.g. height), use `useMotionValue` + `animate()` + `useTransform` and pass the transformed value to `style` so the DOM updates without extra React re-renders.
- **Styling:** Use Tailwind classes, avoid inline styles
- **State Management:** Use TanStack Query for server state, XState Store for client state
- **Forms:** Use TanStack Form via `useAppForm` from `@/components/ui/form`. Use registered field components (e.g. `field.TextField`) inside `form.AppField` and form components (e.g. `form.SubmitButton`) inside `form.AppForm`. See [src/docs/ui.md](src/docs/ui.md) for TanStack Form.
- **Time/Date:** Use existing date utilities, maintain timezone consistency

### Error Handling
- **User-Facing Errors:** Show helpful messages, not technical details
- **API Errors:** Implement retry logic for transient failures
- **Validation:** Fail fast with clear error messages
- **Logging:** Use appropriate log levels, never log sensitive data

### Performance Considerations
- **Route-based Code Splitting:** Automatic with TanStack Router
- **Image Optimization:** Use your host's image transformation if available
- **Query Optimization:** Use Convex indexes for frequent queries
- **Bundle Size:** Check impact before adding new dependencies

### Questions to Ask Before Starting
1. Is this feature in the SPEC.md requirements?
2. Are there existing patterns I should follow?
3. Will this require database schema changes?
4. What are the testing requirements?
5. Are there security implications?

### Related Documentation
- **Planning:** See [docs/planning.md](docs/planning.md) for creating plans with agent and sub-agent usage in mind (owners, dependencies, handoffs). Do not create or save plan artifacts in `docs/`; use the plan tool output or `.cursor/plans/`.
- **Convex data patterns (frontend):** See [src/docs/convex.md](src/docs/convex.md) for mutations (TanStack Query + `useConvexMutation`), no wrapper hooks, and when to use `mutateAsync` vs `mutate`.
- **Convex error handling:** See [convex/docs/error-handling.md](convex/docs/error-handling.md) for ConvexError, shared `errors.ts`, and using one helper.
- **Convex backend testing:** See [convex/docs/testing.md](convex/docs/testing.md) for when to add tests, running tests after Convex changes, convex-test, fixtures, cleanup, API typing (`api.events.mutations`), multi-user tests (`addUserToTest`), factory types (`Doc`, `MutationCtx`), fixture bundling (`.nobundle.ts`), path naming (no dashes in convex paths), and `import.meta.glob` typing (`/// <reference types="vite/client" />`).
- **Convex best practices:** See [convex/AGENTS.md](convex/AGENTS.md) and [convex/docs/](convex/docs/) (schema, patterns, error-handling, testing).
- **Product Requirements:** Refer to `SPEC.md` for feature details
- **UI/UX Design:** Refer to `UI_SPEC.md` for visual design and component specifications
- **UI Components:** Check `components.json` for shadcn configuration
- **Forms and popover patterns:** See [src/docs/ui.md](src/docs/ui.md) for TanStack Form, withForm for breaking big forms into smaller pieces, async initial values (no useEffect), form-components, shared Popover handle, submit-dirty-form-on-close/unmount, clearing external store on unmount, Base UI Combobox value handling, and Button/Toggle component icon sizing.
- **Calendar events:** See [src/docs/calendar-events.md](src/docs/calendar-events.md) for event time display patterns and timezone handling.
- **Drag and Drop:** See [src/docs/dnd-handling.md](src/docs/dnd-handling.md) for locked event handling, distinguishing clicks from drags, and preventing visual drag movement.
- **Deployment:** Build with `pnpm deploy`; deploy `dist/` to your chosen host. OAuth redirect URIs (e.g. Linear) must use your app's real origin (e.g. `https://<your-domain>/settings/integrations/linear-callback`).

---

## Quick Reference

### File Extensions
- `.tsx` - React components with TypeScript
- `.ts` - Pure TypeScript (utilities, types, Convex functions)
- `.md` - Documentation (content collections)
- `.json` / `.jsonc` - Configuration files

### Import Aliases
- `@/*` maps to `src/*` (see Imports above).

### Environment Variable Prefixes
- `VITE_*` - Client-side accessible
- `CONVEX_*` - Convex backend configuration

### Development Workflow
1. Start Convex: `pnpm convex:dev`
2. Start Frontend: `pnpm dev`
3. Make changes
4. Run checks: `pnpm check` (typecheck + lint + format)
5. Test: `pnpm test`
6. Commit with conventional message

### Help Commands
```bash
pnpm run          # List all available scripts
npx convex --help # Convex CLI help
pnpm dlx shadcn@latest add --help # shadcn component help
```

### shadcn Component Installation

**Important:** When installing shadcn components that already exist:
- If prompted to overwrite files, **ask the user** whether to overwrite or skip
- Do not automatically use `--overwrite` flag
- The `--yes` flag only skips initial confirmation, not overwrite prompts
- Available flags: `-y/--yes` (skip initial prompt), `-o/--overwrite` (overwrite without prompts)

---

**Last Updated:** February 2026
**Maintained By:** Development Team
**Questions:** Check README.md, SPEC.md, or UI_SPEC.md for additional context